name: Rendered manifests
on: [pull_request]
jobs:
  render:
    runs-on: ubuntu-latest
    name: Render manifests
    steps:
      - name: Checkout base
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
      - name: Checkout head
        uses: actions/checkout@v3
        with:
          path: head
      - name: Render base
        run: node head/.scripts/render-manifests.mjs base/overlays rendered/base
      - name: Render head
        run: node head/.scripts/render-manifests.mjs head/overlays rendered/head
      - name: Upload manifests
        uses: actions/upload-artifact@v3
        with:
          name: rendered-manifests
          path: rendered/*
  diff:
    runs-on: ubuntu-latest
    needs: render
    name: Compare environments
    outputs:
      empty: ${{ steps.save.outputs.empty }}
    steps:
      - name: Download manifests
        uses: actions/download-artifact@v3
        with:
          name: rendered-manifests
          path: rendered
      - name: Git diff
        run: |
          git diff --no-index --no-renames -- \
          rendered/base rendered/head >> envs.diff || true
      - name: Save state
        id: save
        run: |
          [ -s envs.diff ] && empty="false" || empty="true"
          echo "empty=$empty" >> $GITHUB_OUTPUT
      - name: Render summary
        run: |
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          cat envs.diff >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  polaris:
    runs-on: ubuntu-latest
    needs: render
    name: Polaris
    steps:
      - name: Checkout head
        uses: actions/checkout@v3
      - name: Download manifests
        uses: actions/download-artifact@v3
        with:
          name: rendered-manifests
          path: rendered
      - name: Setup polaris
        uses: fairwindsops/polaris/.github/actions/setup-polaris@master
        with:
          version: 5.0.0
      - name: Run Polaris
        # For each file in rendered/head, add a separator and call polaris
        run: |
          find rendered/head | xargs -i sh -c 'echo "-----\n"; \
          polaris audit --audit-path {} --config polaris.yaml \
          --format=pretty --set-exit-code-on-danger {}'
  pluto:
    runs-on: ubuntu-latest
    needs: render
    name: Pluto
    steps:
      - name: Download Pluto
        uses: FairwindsOps/pluto/github-action@master
      - name: Download manifests
        uses: actions/download-artifact@v3
        with:
          name: rendered-manifests
          path: rendered
      - name: Use pluto
        run: |
          pluto detect-files -d rendered -o markdown \
          --ignore-deprecations  >> $GITHUB_STEP_SUMMARY
  base-modification:
    runs-on: ubuntu-latest
    needs: [render, diff]
    name: Base modification
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Check base changes
        id: changes
        uses: tj-actions/changed-files@v32
        with:
          files: |
            base/**
      - name: Trigger error
        if: |
          steps.changes.outputs.any_changed == 'true'
          && needs.diff.outputs.empty == 'false'
        run: |
          cat docs/errors/base-modifications.txt
          exit 1
